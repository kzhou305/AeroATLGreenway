<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AeroATL Greenway Plan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <script src="./lib/nice-select2-2.0.0/dist/js/nice-select2.js"></script>
    <link rel="stylesheet" href="./lib/nice-select2-2.0.0/dist/css/nice-select2.css"/>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      h1 {
        font-size: 20px;
      }

      h2 {
        font-size: 16px;
        line-height: 20px;
        margin-bottom: 10px;
      }

      a {
        text-decoration: none;
        color: #FFB24A 
;
      }

      #console {
        position: absolute;
        margin: 10px;
        width: 260px;
        background-color: white;
        padding: 10px;
        right: 0px;
      }

      .session {
        margin-bottom: 20px;
      }

      .session2 {
        margin-bottom: 10px;
      }

      #legend div span {
/*        border-radius: 50%;*/
        display: inline-block;
        height: 12px;
        margin-right: 5px;
        margin-left: 5px;
        width: 12px;
        opacity: 0.5;
      }

      .label {
        width: 15%;
        display: inline-block;
        text-align: left;
      }

      .mapboxgl-popup-content {
        padding: 10px;
        line-height: 1.5;
        max-width: 2000px;
      }

      .mapboxgl-popup-tip {
        display: none;
      }

      .mapboxgl-ctrl-directions {
        min-width: 250px;
        max-wdith: 250px;
      }

      .mapbox-directions-instructions {
        display: none;
      }

      .mapbox-directions-component.mapbox-directions-route-summary {
        background-color: white;
        margin: 0px;
        padding-top: 0px;
        padding-bottom: 0px;
        padding-right: 0px;
        line-height: 12px;
      }

      .mapbox-directions-component.mapbox-directions-route-summary h1, .mapbox-directions-component.mapbox-directions-route-summary span {
        color: rgba(0,0,0,.75);
        font-size: 13px;
      }

    </style>
  </head>

  <body>
    <div id="map"></div>
    <p style="font-style: italic; position: absolute; left: 100px; bottom: 25px; font-size: 12px">Map by Xiaofan Liang, Georgia Tech</p> 
    <div id="console">
      <h1>AeroATL Greenway Plan</h1>
      <p>
        Explore how your trips may be improved with AeroATL Greenway Plan! 
        <a
          href="https://aeroatl.org/special-projects/aeroatl-greenway-model-mile/"
          >Learn more about this project here.</a
        > 
      </p>
      <div id = 'directions'>
        <p>
          Double click on the map or type below to choose an origin and destination
        </p>
        <p style="font-size: 12px">
          The visualized trip shows the suggested path by modes in the current road network (without the Greenway Plan). How much of this trip can be covered by the Greenway? Can you think of a better path that makes use of the Greenway? 
        </p>
      </div>
      <div class="session">
        <h2>Show AeroATL Greenway Plan Layer(s)</h2> 
        <div id="selectLayer">
          <input type="checkbox" class="checkbox" checked='checked' value="All"> All
          <br>
          <input type="checkbox" class="checkbox" value="Existing Bike Paths"> Existing Bike Paths
          <br>
          <input type="checkbox" class="checkbox" value="Model Miles"> Model Miles
          <br>
          <input type="checkbox" class="checkbox" value="Priority Network"> Priority Network
          <br>
          <input type="checkbox" class="checkbox" value="Loop Connecting Downtowns"> Loop Connecting Downtowns
          <br>
          <input type="checkbox" class="checkbox" value="Airport Loop"> Airport Loop
          <br>
          <input type="checkbox" class="checkbox" value="Outer Ring"> Outer Ring
          <br>
          <input type="checkbox" class="checkbox" value="Local Connections"> Local Connections
        </div>
      <div id="legend", class="session">
        <h2>Building Types by Color</h2>
        <div><span style="background-color: #5B5558"></span>Airport</div>
        <div><span style="background-color: #9B959D"></span>Infrastructure</div>
        <div><span style="background-color: #890B24"></span>Residence</div>
        <div><span style="background-color: #CB4700"></span>Commerce</div>
        <div><span style="background-color: #FE9C2D"></span>Hotel</div>
        <div><span style="background-color: #0E7C33"></span>Recreation</div>
        <div><span style="background-color: #3C9493"></span>Industry</div>
        <div><span style="background-color: #072C83"></span>Office</div>
        <div><span style="background-color: #6DA8D6"></span>Institution</div>
        <div><span style="background-color: #532788"></span>School</div>
      </div>
    </div>
    <script>
      //reference: https://docs.mapbox.com/help/tutorials/show-changes-over-time/
      //https://docs.mapbox.com/mapbox-gl-js/example/filter-features-within-map-view/
      //https://docs.mapbox.com/mapbox-gl-js/style-spec/expressions/
      //https://docs.mapbox.com/mapbox-gl-js/example/popup/
      //https://codepen.io/ZondaDesign/pen/xxVxZVR //toggle layer

      mapboxgl.accessToken = 'pk.eyJ1IjoieHhmZmxsIiwiYSI6ImNsZmtoY3YzbDAwdng0NG1yOXVqYmFveW4ifQ._VjRhEILbOSWgFVR8dtmSw';
      var map = new mapboxgl.Map({
          container: 'map', // container ID
          style: 'mapbox://styles/mapbox/light-v10', // style URL //dark-v10
          center: [-84.4, 33.64], // starting position [lng, lat]
          zoom: 11.5 // starting zoom
      });

      // Create a popup, but don't add it to the map yet.
      const popup = new mapboxgl.Popup({
        closeButton: true
      });

      function getCheckedValues(className) {
        // Get all checkboxes with the specified class name
        const checkboxes = document.querySelectorAll(`.${className}`);

        // Filter the checked checkboxes and map to their values
        const checkedValues = Array.from(checkboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);

        return checkedValues;
      }

      map.on('load', () => {

        Promise.all([
          fetch('data/Building_mapbox.geojson').then(response => response.json()),
          fetch('data/Greenway_mapbox.geojson').then(response => response.json())
        ])
        .then(([buildingData, greenwayData]) => {
            map.addSource('building', {
              type: 'geojson',
              data: buildingData
            });

            map.addSource('greenway', {
              type: 'geojson',
              data: greenwayData
            });

            map.addLayer({
              id: 'building-layer',
              type: 'fill',
              source: 'building',
              paint: {
                'fill-opacity': 0.3,
                'fill-color': [
                  'match',
                  ['get', 'LU4Vis'],
                  'Airport', '#5B5558',
                  'Infrastructure', '#9B959D',
                  'Commerce', '#CB4700',
                  'Hotel', '#FE9C2D',
                  'Recreation', '#0E7C33',
                  'Office', '#072C83',
                  'Institution', '#6DA8D6',
                  'School', '#532788',
                  'Residence', '#890B24',
                  'Industry', '#3C9493',
                  '#F9F8F8'
                  ]
              }
            });

            map.addLayer({
              id: 'greenway-layer',
              type: 'line',
              source: 'greenway',
              paint: {
                'line-width': 2,
                'line-opacity': 0.8,
                'line-color': '#000101'
              }
            });

            map.on('mouseenter', 'building-layer', (e) => { //mousemove
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer'; 
            // Populate the popup and set its coordinates based on the feature.
            const feature = e.features[0];
            popup
              //.setLngLat(e.lngLat) //for click
              .setLngLat(e.lngLat)
              .setHTML(
              `<p style='margin:0'><b>Zoning Code:</b> ${feature.properties.Zn_ClsC}</p>
               <p style='margin:0'><b>Land Use Code:</b> ${feature.properties.LUCode}</p>
               <p style='margin:0'><b>Land Use Type:</b> ${feature.properties.LUDes}</p>
               <p style='margin:0'><b>Land Use Vis:</b> ${feature.properties.LU4Vis}</p>
               <p style='margin:0'><b>Estimated Jobs:</b> ${feature.properties.BldgJobs}</p>
               <p style='margin:0'><b>Est. Jobs $3333+:</b> ${feature.properties.Jobs3333}</p>`
              )
              .addTo(map);

            //const popupElem = popup.getElement();
            //popupElem.style.border = `2px solid ${feature.properties.f > 50 ? '#800526':'#FFB24A'}`;
            });
               
            map.on('mouseleave', 'building-layer', () => {
              map.getCanvas().style.cursor = '';
              popup.remove();
            });


            // let allCheckBox = document.querySelectorAll('.checkbox')
            // allCheckBox.forEach((checkbox, index) => {
            //   checkbox.addEventListener('change', (event) => {
            //     console.log(event.target.value)
            //   })
            // })

            document
            .getElementById('selectLayer')
            .addEventListener('change', (event) => {
                //console.log(event.target.value)
                event.preventDefault();
                event.stopPropagation();
              const GreenwayLayer = event.target.value;
              const checked = getCheckedValues('checkbox');
              //console.log(checked)
              // update the map filter
              if(checked.includes('All')) {
                map.setFilter('greenway-layer', ['!=', 'AeroATL', ''])
                map.setLayoutProperty('greenway-layer', 'visibility', 'visible')
              } else if (checked.length == 0){
                //console.log('Empty')
                map.setLayoutProperty('greenway-layer', 'visibility', 'none')
              } else {
                //console.log('Multiple')
                map.setFilter('greenway-layer', ['match', ['get', 'AeroATL'], checked, true, false])
                map.setLayoutProperty('greenway-layer', 'visibility', 'visible')
              }
            });
          });
      });
      
      // document.addEventListener('DOMContentLoaded', function(){
      //   const checkboxes = document.querySelectorAll('.checkbox');
      //   checkboxes.forEach((checkbox, index) => {
      //     checkbox.addEventListener('click', function(e){
      //     if(checkbox.checked){
      //       e.stopPropagation();
      //       e.preventDefault();
      //       checkbox.checked=true;
      //       console.log(`Checkbox ${index + 1} is checked`)
      //     } else {
      //       e.stopPropagation();
      //       e.preventDefault();
      //       checkbox.checked=false;
      //       console.log(`Checkbox ${index + 1} is unchecked`)
      //     }
      //     });
      //   });
      // });
      // map.on('idle', () => {
      //   document
      //     .getElementById('selectLayer')
      //     .addEventListener('click', (e) => {
      //       e.preventDefault();
      //       e.stopPropagation();
      //       console.log(e.target.value)
      //     })
      // });
      
      //https://github.com/mapbox/mapbox-gl-directions/blob/master/API.md#mapboxdirections
      const plugin = new MapboxDirections({
          accessToken: mapboxgl.accessToken,
          profile: "mapbox/walking",
          interactive: false,
          controls: {
            instructions: true
          }
      }); 
      //map.addControl(plugin,'top-left');

      //add direction plug in to an existing div 
      document.getElementById('directions').appendChild(plugin.onAdd(map))

      let originSet = false;
      let mouseDown = false;
      let mouseMoved = false;

      //setting mouseDown and moseMoved to prevent the issue where a click and drag followed by a single click trigger a double-click event. 
      map.on('mousedown', () => {
        mouseDown = true;
        mouseMoved = false;
      });

      map.on('mousemove', () => {
        if (mouseDown) {
          mouseMoved = true;
        }
      });

      map.on('mouseup', () => {
        mouseDown = false;
      });

      map.on('dblclick', (event) => {
        //The double-click event handler now checks whether the mouseMoved variable is false before proceeding, which means the double-click event will only be triggered if the mouse wasn't moved between the first and second click.
        if (!mouseMoved) {
          // Get the clicked coordinates
          const coordinates = [event.lngLat.lng, event.lngLat.lat];

          // If the origin hasn't been set, set it
          if (!originSet) {
            plugin.setOrigin(coordinates);
            originSet = true;
          } else {
            // If the origin is set, set the destination and reset the origin flag
            plugin.setDestination(coordinates);
            originSet = false;
          }
        }
      });

    </script>
  </body>
</html>
